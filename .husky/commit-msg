#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” TRAIDER V1 Commit Message Validation"
echo "======================================="

# Get the commit message
commit_regex='^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\(.+\))?: .{1,100}$'

if ! grep -qE "$commit_regex" "$1"; then
  echo "âŒ Invalid commit message format!"
  echo ""
  echo "ğŸ“‹ TRAIDER V1 requires conventional commits:"
  echo "   Format: <type>(scope): <description>"
  echo ""
  echo "ğŸ·ï¸  Valid types:"
  echo "   â€¢ feat:     New feature or trading strategy"
  echo "   â€¢ fix:      Bug fix or trading issue resolution"
  echo "   â€¢ docs:     Documentation changes"
  echo "   â€¢ style:    Code style changes (formatting, etc.)"
  echo "   â€¢ refactor: Code refactoring without behavior change"
  echo "   â€¢ perf:     Performance improvements"
  echo "   â€¢ test:     Test additions or modifications"
  echo "   â€¢ chore:    Maintenance tasks"
  echo "   â€¢ build:    Build system or dependency changes"
  echo "   â€¢ ci:       CI/CD pipeline changes"
  echo "   â€¢ revert:   Reverting previous commits"
  echo ""
  echo "ğŸ“ Example commit messages:"
  echo "   feat(signals): add momentum-based trading signal"
  echo "   fix(risk): resolve position sizing calculation bug"
  echo "   perf(market-data): optimize WebSocket connection handling"
  echo "   docs(api): update trading endpoints documentation"
  echo ""
  echo "ğŸš« Your commit message:"
  cat "$1"
  echo ""
  echo "ğŸ’¡ Please rewrite your commit message and try again."
  exit 1
fi

# Additional validation for trading-critical commits
commit_msg=$(cat "$1")

# Check for breaking changes in trading logic
if echo "$commit_msg" | grep -qE "(BREAKING|breaking|major|critical)"; then
  echo "âš ï¸  BREAKING CHANGE detected in commit message"
  echo "ğŸš¨ This commit may affect trading operations"
  echo "ğŸ“‹ Ensure proper testing and gradual rollout"
  echo ""
fi

# Check for security-related commits
if echo "$commit_msg" | grep -qiE "(security|auth|token|key|secret|vulnerability)"; then
  echo "ğŸ”’ Security-related commit detected"
  echo "ğŸ” Ensure no sensitive information is included"
  echo "ğŸ“‹ Consider security review before deployment"
  echo ""
fi

# Check for performance-critical commits
if echo "$commit_msg" | grep -qiE "(perf|performance|latency|speed|optimization)"; then
  echo "âš¡ Performance-critical commit detected"
  echo "ğŸ“Š Ensure benchmarks are updated"
  echo "ğŸ“‹ Monitor latency metrics after deployment"
  echo ""
fi

echo "âœ… Commit message format validated"
echo "ğŸ“ Message: $(echo "$commit_msg" | head -n1)"
echo "ğŸ¯ Ready for institutional-grade commit!" 